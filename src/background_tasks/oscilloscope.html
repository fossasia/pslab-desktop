<script>
	const { PythonShell } = require('python-shell');
	const { ipcRenderer } = require('electron');
	const loadBalancer = require('electron-load-balancer');
	const path = require('path');

	loadBalancer.onInitialize(ipcRenderer, 'oscilloscope', initialValues => {
		/* -------------------- Blocking code here ----------------------- */

		const { numberOfSamples, timeGap, activeChannels, delay } = initialValues;

		const options = {
			pythonPath: 'python3',
			args: [
				'OSC',
				timeGap,
				numberOfSamples,
				delay,
				activeChannels['ch1'] ? 1 : 0,
				activeChannels['ch2'] ? 1 : 0,
				activeChannels['ch3'] ? 1 : 0,
				activeChannels['ch4'] ? 1 : 0,
			],
		};

		let pyshell = new PythonShell(path.join(__dirname, '/../scripts/bridge.py'), options);

		loadBalancer.onFinish(ipcRenderer, 'oscilloscope', () => {
			pyshell.send('STOP');
		});

		pyshell.on('message', function(results) {
			try {
				const parsedJSON = JSON.parse(results);
				const keys = Object.keys(parsedJSON);
				parsedOutput = parsedJSON[keys[0]].map((item, index) => {
					return {
						timeGap: index * timeGap,
						[keys[0]]: item,
					};
				});
				ipcRenderer.send('TO_RENDERER_OSC_DATA', parsedOutput);
			} catch (error) {
				console.log(error);
			}
		});

		/* --------------------------------------------------------------- */
	});
</script>
