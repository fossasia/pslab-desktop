<script>
	const { PythonShell } = require('python-shell');
	const { ipcRenderer } = require('electron');
	const loadBalancer = require('electron-load-balancer');
	const path = require('path');
	const { oscilloscopeDataProcessor } = require('../utils/preProcessor.js');
	const log = require('electron-log');

	let pyshell = new PythonShell(path.join(__dirname, '/../scripts/bridge.py'), {
			pythonPath: 'python3',
	});

	loadBalancer.onInitialize(ipcRenderer, 'linker', initialValues => {
		/* -------------------- Blocking code here ----------------------- */

		loadBalancer.on(ipcRenderer, 'linker', args => {
			pyshell.send(JSON.stringify(args));
		});

		pyshell.on('stderr', function (stderr) {
			log.info(stderr);
		});

		pyshell.on('message', function(results) {
			try {
				const parsedJSON = JSON.parse(results);
				ipcRenderer.send('DEBUG', parsedJSON);
				switch (parsedJSON['type']) {
					case 'START_OSC':	
						if(parsedJSON.isFFT){
							parsedOutput = oscilloscopeDataProcessor(parsedJSON);
							ipcRenderer.send('TO_RENDERER_DATA', {data: parsedOutput});
						}
						else{
							parsedOutput = oscilloscopeDataProcessor(parsedJSON);
							ipcRenderer.send('TO_RENDERER_DATA', {data: parsedOutput});
						}	
						break;
					case 'START_MUL_MET':
						ipcRenderer.send('TO_RENDERER_DATA', {data: parsedJSON.data, prefix: parsedJSON.prefix});
						break;
					case 'GET_CONFIG_PWR_SRC':
						ipcRenderer.send('TO_RENDERER_CONFIG', parsedJSON);
						break;
					case 'GET_CONFIG_OSC':
						ipcRenderer.send('TO_RENDERER_CONFIG', parsedJSON);
						break;
					case 'GET_CONFIG_MUL_MET':
						ipcRenderer.send('TO_RENDERER_CONFIG', parsedJSON);
						break;
					case 'GET_CONFIG_WAV_GEN':
						ipcRenderer.send('TO_RENDERER_CONFIG', parsedJSON);
						break;
					case 'DEVICE_CONNECTION_STATUS':
						ipcRenderer.send('TO_RENDERER_STATUS', parsedJSON);
						break;
					default:
						break;
				}
			} catch (error) {
				log.error(error);
			}
		});
		/* --------------------------------------------------------------- */
	},
	() => {
		pyshell.terminate();
	});
</script>
